<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Timer Allenamento ‚Äì Mini App</title>
<meta name="theme-color" content="#0f1115">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{ --bg:#0f1115; --panel:#171a21; --accent:#68d391; --accent2:#61dafb; --danger:#ff6b6b; --muted:#a0aec0; --text:#e2e8f0; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1200px 800px at 10% 10%, #151821, #0f1115); color: var(--text); }
  header{ padding: 18px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid #222631; position: sticky; top:0; backdrop-filter: blur(6px); }
  h1{ font-size: clamp(18px, 2.6vw, 26px); margin:0; letter-spacing:.4px; }
  .sub{ color: var(--muted); font-size:12px; }
  main{ display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; }
  @media (max-width: 950px){ main{ grid-template-columns: 1fr; } }
  .card{ background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid #232735; border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.22); }
  .controls .row{ display:grid; grid-template-columns: 1.2fr 1fr; gap:8px; margin-bottom:10px; }
  label{font-size:12px; color:var(--muted); margin-bottom:6px; display:block}
  input, select, button, textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2b3040; background:#0d0f14; color:var(--text); outline:none; }
  input[type="number"]{appearance:textfield} input[type="range"]{height: 32px;}
  button{ background: linear-gradient(180deg, #1e2230, #171a24); cursor:pointer; transition:.2s ease; }
  button:hover{transform: translateY(-1px);} button.primary{ background: linear-gradient(180deg, #2a9d6f, #238f65); border: 1px solid #2fbf7f; color:#07140e; font-weight:700; }
  button.secondary{border:1px solid #2b7a9f; background: linear-gradient(180deg, #1a3442, #162a35)} button.ghost{background:transparent; border-color:#2b3040; color:var(--muted)}
  .btn-row{display:flex; gap:8px; flex-wrap:wrap} .grid-3{display:grid; grid-template-columns: repeat(3,1fr); gap:8px} .grid-2{display:grid; grid-template-columns: repeat(2,1fr); gap:8px}
  .muted{color:var(--muted)} .timer{ display:flex; flex-direction:column; align-items:center; justify-content:center; min-height: 360px; padding: 20px; border-radius: 14px; border:1px solid #233044;
    background: radial-gradient(700px 300px at 50% 20%, rgba(104,211,145,.12), rgba(255,255,255,0)); }
  .time{ font-size: clamp(56px, 9vw, 96px); font-weight: 800; letter-spacing: 2px; }
  .label{ margin-top:8px; font-size:14px; color:#b7c2d1 } .progress{ margin-top:14px; width:100%; height:10px; background:#0b0e13; border-radius:999px; border:1px solid #23293a; overflow:hidden; }
  .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .25s linear; }
  .stack{display:flex; align-items:center; justify-content:space-between; gap:8px} .kbd{ border:1px solid #2b3040; border-bottom-width:2px; padding:2px 6px; border-radius:6px; font-size:11px; color:#aab6c6; background:#0e1218; }
  .list{display:flex; flex-direction:column; gap:8px; margin-top:8px} .list .item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border:1px dashed #2b3040; border-radius:10px; }
  .tiny{font-size:11px; color:#94a3b8} .ok{color:var(--accent)} .danger{color:var(--danger)} footer{ padding: 10px 16px; color:#8693a6; border-top:1px solid #222631; font-size:12px }
</style>
</head>
<body>
<header>
  <div>
    <h1>Timer Allenamento ‚Äì Mini App</h1>
    <div class="sub">Intervalli ‚Ä¢ Circuito ‚Ä¢ Set/Serie ‚Äì con beep, voce e preset ‚Ä¢ PWA</div>
  </div>
  <div class="stack tiny">
    <div class="kbd">Spazio</div> start/pausa
    <div class="kbd">N</div> avanti
    <div class="kbd">R</div> reset
  </div>
</header>

<main>
  <!-- Controls -->
  <section class="card controls">
    <div class="row">
      <div>
        <label for="mode">Modalit√†</label>
        <select id="mode">
          <option value="interval">HIIT/Intervalli (work & rest)</option>
          <option value="circuit">Circuito (esercizi x giri + recuperi)</option>
          <option value="sets">Set/Serie (conta set + recupero fisso)</option>
        </select>
      </div>
      <div>
        <label for="preset">Preset</label>
        <select id="preset">
          <option value="">‚Äî Nessun preset ‚Äî</option>
          <option value="lunedi">Luned√¨ ‚Äì Full Body dolce</option>
          <option value="mercoledi">Mercoled√¨ ‚Äì HIIT Low Impact</option>
          <option value="venerdi">Venerd√¨ ‚Äì Lower Body & Core</option>
        </select>
      </div>
    </div>

    <div id="config-interval">
      <div class="grid-3">
        <div>
          <label>Lavoro (sec)</label>
          <input type="number" id="int-work" min="5" value="40">
        </div>
        <div>
          <label>Recupero (sec)</label>
          <input type="number" id="int-rest" min="5" value="20">
        </div>
        <div>
          <label>Stazioni</label>
          <input type="number" id="int-stations" min="1" value="6">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Giri (round)</label>
          <input type="number" id="int-rounds" min="1" value="2">
        </div>
        <div>
          <label>Recupero tra giri (sec)</label>
          <input type="number" id="int-between-rounds" min="0" value="120">
        </div>
      </div>
    </div>

    <div id="config-circuit" style="display:none">
      <div class="grid-3">
        <div>
          <label>Esercizi per giro</label>
          <input type="number" id="c-exercises" min="1" value="6">
        </div>
        <div>
          <label>Tempo per esercizio (sec)</label>
          <input type="number" id="c-work" min="5" value="45">
        </div>
        <div>
          <label>Recupero tra esercizi (sec)</label>
          <input type="number" id="c-rest" min="0" value="30">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Giri (round)</label>
          <input type="number" id="c-rounds" min="1" value="3">
        </div>
        <div>
          <label>Recupero tra giri (sec)</label>
          <input type="number" id="c-between-rounds" min="0" value="60">
        </div>
      </div>
    </div>

    <div id="config-sets" style="display:none">
      <div class="grid-3">
        <div>
          <label>Nome esercizio</label>
          <input type="text" id="s-name" placeholder="es. Ponte glutei">
        </div>
        <div>
          <label>Numero set</label>
          <input type="number" id="s-sets" min="1" value="3">
        </div>
        <div>
          <label>Recupero tra set (sec)</label>
          <input type="number" id="s-rest" min="5" value="60">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Durata lavoro (sec) ‚Äì opzionale</label>
          <input type="number" id="s-work" min="0" value="0">
        </div>
        <div>
          <label>Avanzamento set</label>
          <select id="s-advance">
            <option value="manual">Manuale (clic/Barra spaziatrice)</option>
            <option value="auto">Automatico (usa durata lavoro)</option>
          </select>
        </div>
      </div>
      <div class="tiny" style="margin-top:8px">
        Suggerimento: usa questa modalit√† quando vuoi contare i set di un singolo esercizio e avere il <b>rest</b> fisso tra un set e l'altro.
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Voce guida</label>
        <select id="voice-toggle">
          <option value="off">Spenta</option>
          <option value="on">Accesa</option>
        </select>
      </div>
      <div>
        <label>Volume beep</label>
        <input type="range" id="beep-volume" min="0" max="100" value="70">
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px">
      <button id="btn-start" class="primary">‚ñ∂ Avvia</button>
      <button id="btn-pause">‚è∏ Pausa</button>
      <button id="btn-next" class="secondary">‚è≠ Avanti</button>
      <button id="btn-reset" class="ghost">‚Ü∫ Reset</button>
      <button id="btn-save" class="ghost">üíæ Salva come preset</button>
    </div>

    <div class="list" id="saved-list"></div>
  </section>

  <!-- Timer -->
  <section class="card">
    <div class="timer" id="timer">
      <div class="time" id="display">00:00</div>
      <div class="label" id="status">Pronto</div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="stack tiny" style="margin-top:10px; width:100%">
        <div><span class="kbd">Spazio</span> start/pausa ‚Ä¢ <span class="kbd">N</span> avanti ‚Ä¢ <span class="kbd">R</span> reset</div>
        <div id="substatus"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="stack" style="gap:10px">
        <div>
          <div class="tiny">Stato sessione</div>
          <div id="session-state" class="muted">‚Äî</div>
        </div>
        <div>
          <div class="tiny">Round</div>
          <div id="round-state" class="muted">‚Äî</div>
        </div>
        <div>
          <div class="tiny">Esercizio/Set</div>
          <div id="ex-state" class="muted">‚Äî</div>
        </div>
        <div>
          <div class="tiny">Tempo totale</div>
          <div id="elapsed" class="muted">00:00</div>
        </div>
      </div>
    </div>

  </section>
</main>

<footer>
  PWA offline. Dopo la pubblicazione su HTTPS, apri in Safari e usa "Condividi ‚Üí Aggiungi a Home".
</footer>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
function fmt(t){ t = Math.max(0, Math.round(t)); const m = Math.floor(t/60).toString().padStart(2,'0'); const s = (t%60).toString().padStart(2,'0'); return `${m}:${s}`; }

const Speech = (() => {
  let ready = false;
  let queue = [];
  let countdownTimer = null;

  function init() {
    if (ready) return;
    const onInteract = () => { ready = true; try { speechSynthesis.cancel(); } catch(e) {} drain(); };
    ['click','keydown','touchstart'].forEach(ev =>
      window.addEventListener(ev, onInteract, { once:true, passive:true })
    );
  }

  function say(text) {
    const toggle = document.querySelector('#voice-toggle');
    if (toggle && toggle.value !== 'on') return;
    if (!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(String(text));
    u.rate = 1.02; u.pitch = 1.0;
    u.onend = () => drain();
    queue.push(u);
    if (ready) drain();
  }

  function drain() {
    if (!queue.length || (speechSynthesis.speaking)) return;
    try { speechSynthesis.speak(queue.shift()); } catch(e) {}
  }

  function stop() { queue = []; clearCountdown(); try { speechSynthesis.cancel(); } catch(e) {} }
  function clearCountdown(){ if (countdownTimer) { clearInterval(countdownTimer); countdownTimer=null; } }

  function countdown(sec = 3) {
    clearCountdown(); ensureAudio();
    let n = sec;
    // Pronuncia subito il primo numero!
    say(String(n));
    beep(880, 90);
    n--;
    countdownTimer = setInterval(() => {
      if (n <= 0) { clearCountdown(); return; }
      say(String(n));
      beep(880, 90);
      n--;
    }, 1000);
  }

  init();
  return { say, stop, countdown, clearCountdown };
})();

let audioCtx = null, masterGain = null;
function ensureAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = $('#beep-volume').value/100; masterGain.connect(audioCtx.destination); }
function beep(freq=880, dur=140, type='sine'){ ensureAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.value = freq;
  gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.7, audioCtx.currentTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur/1000); osc.connect(gain); gain.connect(masterGain); osc.start(); osc.stop(audioCtx.currentTime + dur/1000 + 0.01); }
$('#beep-volume').addEventListener('input', e=>{ ensureAudio(); masterGain.gain.value = e.target.value/100; });

let running = false; let startStamp = null; let totalElapsed = 0; let tickHandle = null;
function resetClock(){ running = false; startStamp = null; totalElapsed = 0; clearInterval(tickHandle);
  $('#display').textContent = '00:00'; $('#status').textContent = 'Pronto'; $('#bar').style.width = '0%';
  $('#session-state').textContent = '‚Äî'; $('#round-state').textContent = '‚Äî'; $('#ex-state').textContent = '‚Äî'; $('#elapsed').textContent = '00:00'; $('#substatus').textContent = ''; }
function start(){ ensureAudio(); if(!running){ running = true; startStamp = performance.now(); tickHandle = setInterval(tick, 100); } }
function pause(){ if(running){ running = false; clearInterval(tickHandle); } else { start(); } }
function nextStep(){ if(controller && controller.next) controller.next(); }
function tick(){ if(controller && controller.update) controller.update(); $('#elapsed').textContent = fmt(totalElapsed + (running ? (performance.now()-startStamp)/1000 : 0)); }

let controller = null;
class IntervalController{
  constructor(cfg){ this.work=+cfg.work; this.rest=+cfg.rest; this.stations=+cfg.stations; this.rounds=+cfg.rounds; this.br=+cfg.betweenRounds; this.reset(); }
  reset(){ this.mode='work'; this.t=this.work; this.station=1; this.round=1; this.done=false; this.didCountdown=false; resetClock();
    $('#session-state').textContent='HIIT Intervalli'; $('#round-state').textContent=`${this.round}/${this.rounds}`; $('#ex-state').textContent=`Stazione ${this.station}/${this.stations}`;
    $('#status').textContent='Lavoro'; $('#display').textContent=fmt(this.t); $('#bar').style.width='0%'; }
  update(){ if(!running) return; this.t-=0.1; $('#display').textContent=fmt(this.t); const max=(this.mode==='work')?this.work:(this.mode==='rest'?this.rest:this.br);
    $('#bar').style.width = Math.max(0, Math.min(100, (1 - this.t/max)*100)) + '%';

    // Countdown per rest e work
    if ((this.mode==='rest' || this.mode==='work') && !this.didCountdown && Math.round(this.t) === 3){
      this.didCountdown=true; Speech.countdown(3);
    }

    if(this.t<=0){ 
      if(this.mode==='work'){ 
        this.mode='rest'; 
        this.t=this.rest; 
        $('#status').textContent='Recupero'; 
        Speech.say('Recupero'); 
        const nextStation=(this.station < this.stations)?(this.station+1):1; 
        Speech.say(`Prossimo: stazione ${nextStation}`); 
        this.didCountdown=false; 
        beep(880,120); 
      }
      else if(this.mode==='rest'){ 
        if(this.station<this.stations){ 
          this.station++; 
          this.mode='work'; 
          this.t=this.work; 
          $('#status').textContent='Lavoro'; 
          $('#ex-state').textContent=`Stazione ${this.station}/${this.stations}`; 
          beep(1200,120); 
        }
        else { 
          if(this.round<this.rounds){ 
            this.round++; 
            this.station=1; 
            $('#round-state').textContent=`${this.round}/${this.rounds}`;
            if(this.br>0){ 
              this.mode='between'; 
              this.t=this.br; 
              $('#status').textContent='Recupero tra giri'; 
              Speech.say('Recupero tra giri'); 
              beep(600,150); 
            }
            else { 
              this.mode='work'; 
              this.t=this.work; 
              $('#status').textContent='Lavoro'; 
              beep(1200,120); 
            } 
            $('#ex-state').textContent=`Stazione ${this.station}/${this.stations}`; 
          }
          else { 
            this.done=true; 
            running=false; 
            Speech.say('Sessione completata'); 
            beep(1000,200); 
            beep(1200,200); 
            $('#status').textContent='Completato'; 
          } 
        } 
      }
      else if(this.mode==='between'){ 
        this.mode='work'; 
        this.t=this.work; 
        $('#status').textContent='Lavoro'; 
        Speech.say('Vai!'); 
        beep(1200,120); 
      } 
    }
    if (this.mode==='rest' && !this.didCountdown && this.t<=3.1){ this.didCountdown=true; Speech.countdown(3); }
  }
  next(){ this.t = 0.01; }
}
class CircuitController{
  constructor(cfg){ this.exercises=+cfg.exercises; this.work=+cfg.work; this.rest=+cfg.rest; this.rounds=+cfg.rounds; this.br=+cfg.betweenRounds; this.reset(); }
  reset(){ this.mode='work'; this.t=this.work; this.ex=1; this.round=1; this.didCountdown=false; resetClock(); $('#session-state').textContent='Circuito'; $('#round-state').textContent=`${this.round}/${this.rounds}`;
    $('#ex-state').textContent=`Esercizio ${this.ex}/${this.exercises}`; $('#status').textContent='Lavoro'; $('#display').textContent=fmt(this.t); }
  update(){ if(!running) return; this.t-=0.1; $('#display').textContent=fmt(this.t); const max=(this.mode==='work')?this.work:(this.mode==='rest'?this.rest:this.br);
    $('#bar').style.width = Math.max(0, Math.min(100, (1 - this.t/max)*100)) + '%';
    if ((this.mode==='rest' || this.mode==='work') && !this.didCountdown && Math.round(this.t) === 3){
      this.didCountdown=true; Speech.countdown(3);
    }
    if(this.t<=0){ 
      if(this.mode==='work'){ 
        this.mode='rest'; 
        this.t=this.rest; 
        $('#status').textContent='Recupero'; 
        Speech.say('Recupero'); 
        const nextEx=(this.ex < this.exercises)?(this.ex+1):1; 
        Speech.say(`Prossimo: esercizio ${nextEx}`); 
        this.didCountdown=false; 
        beep(880,120); 
      }
      else if(this.mode==='rest'){ 
        if(this.ex<this.exercises){ 
          this.ex++; 
          this.mode='work'; 
          this.t=this.work; 
          $('#status').textContent='Lavoro'; 
          $('#ex-state').textContent=`Esercizio ${this.ex}/${this.exercises}`; 
          beep(1200,120); 
          this.didCountdown=false; 
        }
        else { 
          if(this.round<this.rounds){ 
            this.round++; 
            this.ex=1; 
            $('#round-state').textContent=`${this.round}/${this.rounds}`;
            if(this.br>0){ 
              this.mode='between'; 
              this.t=this.br; 
              $('#status').textContent='Recupero tra giri'; 
              Speech.say('Recupero tra giri'); 
              beep(600,150); 
              this.didCountdown=false; 
            }
            else { 
              this.mode='work'; 
              this.t=this.work; 
              $('#status').textContent='Lavoro'; 
              beep(1200,120); 
              this.didCountdown=false;
            } 
            $('#ex-state').textContent=`Esercizio ${this.ex}/${this.exercises}`; 
          }
          else { 
            running=false; 
            Speech.say('Sessione completata'); 
            beep(1000,200); 
            beep(1200,200); 
            $('#status').textContent='Completato'; 
          } 
        } 
      }
      else if(this.mode==='between'){ 
        this.mode='work'; 
        this.t=this.work; 
        $('#status').textContent='Lavoro'; 
        Speech.say('Vai!'); 
        beep(1200,120); 
        this.didCountdown=false; 
      } 
    }
  }
  next(){ this.t = 0.01; }
}
class SetsController{
  constructor(cfg){ this.name=cfg.name||'Esercizio'; this.sets=+cfg.sets; this.rest=+cfg.rest; this.work=Math.max(0,+cfg.work||0); this.advance=cfg.advance||'manual'; this.reset(); }
  reset(){ this.current=1; this.mode=this.work>0 && this.advance==='auto' ? 'work' : 'idle'; this.t=this.mode==='work'?this.work:0; this.didCountdown=false; resetClock();
    $('#session-state').textContent='Set/Serie'; $('#round-state').textContent=`‚Äî`; $('#ex-state').textContent=`${this.name}: set ${this.current}/${this.sets}`;
    $('#status').textContent = this.mode==='work' ? 'Lavoro' : 'Pronto'; $('#display').textContent= fmt(this.t); }
  update(){ if(!running) return; if(this.mode==='idle') return; this.t-=0.1; $('#display').textContent=fmt(this.t); const max=(this.mode==='work')?Math.max(1,this.work):Math.max(1,this.rest);
    $('#bar').style.width = Math.max(0, Math.min(100, (1 - this.t/max)*100)) + '%';
    if(this.t<=0){ if(this.mode==='work'){ this.mode='rest'; this.t=this.rest; $('#status').textContent='Recupero'; Speech.say('Recupero'); if(this.current < this.sets){ Speech.say(`Prossimo: set ${this.current+1}`); } this.didCountdown=false; beep(880,120); }
      else if(this.mode==='rest'){ if(this.current<this.sets){ this.current++; $('#ex-state').textContent=`${this.name}: set ${this.current}/${this.sets}`;
          if(this.advance==='auto' && this.work>0){ this.mode='work'; this.t=this.work; $('#status').textContent='Lavoro'; Speech.say('Vai'); beep(1200,120); }
          else { this.mode='idle'; running=false; $('#status').textContent='Pronto (avanza manualmente)'; Speech.say('Pronto'); beep(1200,120); } }
        else { running=false; beep(1000,200); beep(1200,200); Speech.say('Esercizio completato'); $('#status').textContent='Completato'; } } }
    if (this.mode==='rest' && !this.didCountdown && this.t<=3.1){ this.didCountdown=true; Speech.countdown(3); }
  }
  next(){ ensureAudio(); if(this.mode==='idle'){ this.mode=(this.advance==='auto' && this.work>0)?'work':'rest'; this.t=this.mode==='work'?this.work:this.rest;
      if(this.mode==='work'){ $('#status').textContent='Lavoro'; Speech.say('Vai'); } else { $('#status').textContent='Recupero'; Speech.say('Recupero'); this.didCountdown=false; } start();
    } else { this.t=0.01; } }
}
function buildControllerFromUI(){
  const mode = $('#mode').value;
  if(mode==='interval'){ controller = new IntervalController({ work: $('#int-work').value, rest: $('#int-rest').value, stations: $('#int-stations').value, rounds: $('#int-rounds').value, betweenRounds: $('#int-between-rounds').value }); }
  else if(mode==='circuit'){ controller = new CircuitController({ exercises: $('#c-exercises').value, work: $('#c-work').value, rest: $('#c-rest').value, rounds: $('#c-rounds').value, betweenRounds: $('#c-between-rounds').value }); }
  else { controller = new SetsController({ name: $('#s-name').value, sets: $('#s-sets').value, rest: $('#s-rest').value, work: $('#s-work').value, advance: $('#s-advance').value }); }
}
function updateConfigVisibility(){ $('#config-interval').style.display = $('#mode').value==='interval' ? '' : 'none'; $('#config-circuit').style.display  = $('#mode').value==='circuit'  ? '' : 'none'; $('#config-sets').style.display     = $('#mode').value==='sets'     ? '' : 'none'; }
$('#mode').addEventListener('change', ()=>{ updateConfigVisibility(); buildControllerFromUI(); });
const BUILT_IN = { 'lunedi': { mode:'circuit', c:{exercises:6, work:45, rest:30, rounds:3, betweenRounds:60} }, 'mercoledi': { mode:'interval', i:{work:40, rest:20, stations:6, rounds:2, betweenRounds:120} }, 'venerdi': { mode:'circuit', c:{exercises:5, work:45, rest:30, rounds:3, betweenRounds:60} } };
$('#preset').addEventListener('change', e=>{
  const key=e.target.value; if(!key) return; const p = BUILT_IN[key] || JSON.parse(localStorage.getItem('preset:'+key) || 'null'); if(!p) return;
  $('#mode').value = p.mode || 'interval'; updateConfigVisibility();
  if(p.i){ $('#int-work').value=p.i.work; $('#int-rest').value=p.i.rest; $('#int-stations').value=p.i.stations; $('#int-rounds').value=p.i.rounds; $('#int-between-rounds').value=p.i.betweenRounds; }
  if(p.c){ $('#c-exercises').value=p.c.exercises; $('#c-work').value=p.c.work; $('#c-rest').value=p.c.rest; $('#c-rounds').value=p.c.rounds; $('#c-between-rounds').value=p.c.betweenRounds; }
  if(p.s){ $('#s-name').value=p.s.name||''; $('#s-sets').value=p.s.sets||3; $('#s-rest').value=p.s.rest||60; $('#s-work').value=p.s.work||0; $('#s-advance').value=p.s.advance||'manual'; }
  buildControllerFromUI(); resetClock();
});
$('#btn-save').addEventListener('click', ()=>{
  const name = prompt('Nome del preset (es. "HIIT 40/20 x 3"):'); if(!name) return; const key='user:'+name.toLowerCase().replace(/\s+/g,'-'); const mode=$('#mode').value; const preset={mode};
  if(mode==='interval'){ preset.i={ work:+$('#int-work').value, rest:+$('#int-rest').value, stations:+$('#int-stations').value, rounds:+$('#int-rounds').value, betweenRounds:+$('#int-between-rounds').value }; }
  else if(mode==='circuit'){ preset.c={ exercises:+$('#c-exercises').value, work:+$('#c-work').value, rest:+$('#c-rest').value, rounds:+$('#c-rounds').value, betweenRounds:+$('#c-between-rounds').value }; }
  else { preset.s={ name:$('#s-name').value, sets:+$('#s-sets').value, rest:+$('#s-rest').value, work:+$('#s-work').value, advance:$('#s-advance').value }; }
  localStorage.setItem('preset:'+key, JSON.stringify(preset)); renderSaved(); alert('Preset salvato!'); });
function renderSaved(){ const list=$('#saved-list'); list.innerHTML=''; Object.keys(localStorage).filter(k=>k.startsWith('preset:user:')).forEach(k=>{
  const p=JSON.parse(localStorage.getItem(k)); const div=document.createElement('div'); div.className='item'; const title=k.replace('preset:user:','').replace(/-/g,' ');
  const small=document.createElement('div'); small.className='tiny'; let desc=p.mode;
  if(p.i) desc+=` ‚Ä¢ ${p.i.work}/${p.i.rest} ‚Ä¢ stazioni ${p.i.stations} ‚Ä¢ giri ${p.i.rounds}`; if(p.c) desc+=` ‚Ä¢ ${p.c.exercises} esercizi ‚Ä¢ ${p.c.work}/${p.c.rest} ‚Ä¢ giri ${p.c.rounds}`; if(p.s) desc+=` ‚Ä¢ ${p.s.sets} set ‚Ä¢ rest ${p.s.rest}s`;
  small.textContent=desc; const left=document.createElement('div'); left.innerHTML=`<div style="font-weight:700">${title}</div>`; left.appendChild(small);
  const btns=document.createElement('div'); btns.className='btn-row'; const load=document.createElement('button'); load.textContent='Carica'; load.className='secondary';
  load.addEventListener('click', ()=>{ if(p.mode==='interval'){ $('#mode').value='interval'; updateConfigVisibility(); $('#int-work').value=p.i.work; $('#int-rest').value=p.i.rest; $('#int-stations').value=p.i.stations; $('#int-rounds').value=p.i.rounds; $('#int-between-rounds').value=p.i.betweenRounds; }
    else if(p.mode==='circuit'){ $('#mode').value='circuit'; updateConfigVisibility(); $('#c-exercises').value=p.c.exercises; $('#c-work').value=p.c.work; $('#c-rest').value=p.c.rest; $('#c-rounds').value=p.c.rounds; $('#c-between-rounds').value=p.c.betweenRounds; }
    else { $('#mode').value='sets'; updateConfigVisibility(); $('#s-name').value=p.s.name; $('#s-sets').value=p.s.sets; $('#s-rest').value=p.s.rest; $('#s-work').value=p.s.work; $('#s-advance').value=p.s.advance; } buildControllerFromUI(); resetClock(); });
  const del=document.createElement('button'); del.textContent='Elimina'; del.className='ghost'; del.addEventListener('click', ()=>{ localStorage.removeItem(k); renderSaved(); });
  btns.appendChild(load); btns.appendChild(del); div.appendChild(left); div.appendChild(btns); list.appendChild(div); }); }
$('#btn-start').addEventListener('click', ()=>{ buildControllerFromUI(); start(); }); $('#btn-pause').addEventListener('click', pause); $('#btn-next').addEventListener('click', nextStep);
$('#btn-reset').addEventListener('click', ()=>{ buildControllerFromUI(); controller.reset(); });
document.addEventListener('keydown', (e)=>{ if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return; if(e.code==='Space'){ e.preventDefault(); pause(); } if(e.key.toLowerCase()==='n'){ e.preventDefault(); nextStep(); } if(e.key.toLowerCase()==='r'){ e.preventDefault(); buildControllerFromUI(); controller.reset(); } });
updateConfigVisibility(); buildControllerFromUI(); renderSaved();
setInterval(()=>{ let txt=''; if(controller instanceof IntervalController){ txt = `Round ${controller.round}/${controller.rounds} ‚Ä¢ Stazione ${controller.station}/${controller.stations} ‚Ä¢ ${controller.mode}`; }
else if(controller instanceof CircuitController){ txt = `Round ${controller.round}/${controller.rounds} ‚Ä¢ Esercizio ${controller.ex}/${controller.exercises} ‚Ä¢ ${controller.mode}`; }
else if(controller instanceof SetsController){ txt = `${controller.name} ‚Ä¢ Set ${controller.current}/${controller.sets} ‚Ä¢ ${controller.mode}`; } $('#substatus').textContent = txt; }, 200);
</script>
</body>
</html>
